<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChemScan Pro - Visão Imersiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: black;
        }

        .scan-frame-active {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5), inset 0 0 20px rgba(59, 130, 246, 0.2);
            transform: scale(1.02);
            border-color: #3b82f6 !important;
        }

        /* Esconder scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .bounding-box {
            position: absolute;
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
        }
        
        .box-label {
            background: #3b82f6;
            color: white;
            font-size: 8px;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 0 0 2px 0;
            white-space: nowrap;
        }

        /* Garantir que o vídeo cubra tudo */
        #video {
            object-fit: cover;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body class="text-slate-100 min-h-screen flex flex-col overflow-hidden">

    <!-- HUD Header (Flutuante) -->
    <header class="fixed top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/80 to-transparent flex items-center justify-between z-50 pointer-events-none">
        <div class="flex items-center gap-2 pointer-events-auto">
            <div class="bg-blue-600/20 backdrop-blur-md p-2 rounded-xl border border-blue-500/30">
                <i data-lucide="atom" class="text-blue-400 w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight text-white drop-shadow-md">ChemScan <span class="text-blue-500">PRO</span></h1>
        </div>
        <button id="reset-btn" class="hidden pointer-events-auto p-2 bg-black/40 backdrop-blur-md border border-white/10 rounded-full active:scale-90 transition-transform">
            <i data-lucide="refresh-cw" class="w-5 h-5 text-white"></i>
        </button>
    </header>

    <!-- Conteúdo Principal -->
    <main class="relative flex-1 bg-black overflow-hidden">
        
        <!-- Tela de Ativação Inicial -->
        <div id="setup-view" class="absolute inset-0 flex flex-col items-center justify-center p-10 text-center space-y-8 bg-slate-950 z-[60]">
            <div class="p-8 rounded-full bg-slate-900 border-4 border-blue-500/30 animate-pulse">
                <i data-lucide="camera" class="w-12 h-12 text-blue-500"></i>
            </div>
            <div class="space-y-4">
                <h2 class="text-2xl font-black text-white">Visão Atómica</h2>
                <p class="text-slate-400 text-sm max-w-xs mx-auto leading-relaxed">
                    Ative a câmara para medir dimensões e analisar a composição química de objetos.
                </p>
            </div>
            <button id="start-camera-btn" class="w-full max-w-xs py-5 bg-blue-600 hover:bg-blue-500 text-white font-black text-lg rounded-2xl shadow-2xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                INICIAR SENSORES
            </button>
        </div>

        <!-- Camera Viewport (100% Ecrã) -->
        <div id="camera-view" class="hidden absolute inset-0 w-full h-full">
            <video id="video" autoplay playsinline muted></video>
            
            <!-- Interface HUD de Scan -->
            <div class="absolute inset-0 z-20 pointer-events-none flex flex-col items-center justify-center">
                
                <!-- Frame Central Minimalista -->
                <div id="scan-frame" class="w-64 h-64 border border-white/20 rounded-3xl transition-all duration-300 flex items-center justify-center relative">
                    <!-- Cantos HUD -->
                    <div class="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-blue-500 rounded-tl-3xl opacity-60"></div>
                    <div class="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-blue-500 rounded-tr-3xl opacity-60"></div>
                    <div class="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-blue-500 rounded-bl-3xl opacity-60"></div>
                    <div class="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-blue-500 rounded-br-3xl opacity-60"></div>
                    
                    <i data-lucide="plus" class="text-blue-500/30 w-6 h-6"></i>
                </div>

                <!-- Status flutuante na parte inferior -->
                <div class="absolute bottom-24 left-0 right-0 flex flex-col items-center gap-4">
                    <div id="status-container" class="bg-black/60 backdrop-blur-md px-6 py-2 rounded-full border border-white/10 shadow-2xl">
                        <p id="status-text" class="text-white font-bold text-[10px] uppercase tracking-[0.2em]">Pressione e segure para escanear</p>
                    </div>

                    <!-- Barra de Progresso HUD -->
                    <div id="progress-container" class="hidden w-64 h-1 bg-white/10 rounded-full overflow-hidden backdrop-blur-sm">
                        <div id="progress-bar" class="h-full bg-blue-500 shadow-[0_0_10px_#3b82f6] w-0 transition-all duration-100"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados View (Overlay Deslizante) -->
        <div id="results-view" class="hidden absolute inset-0 z-40 flex flex-col bg-slate-950 no-scrollbar overflow-y-auto pb-32">
            
            <!-- Imagem Capturada -->
            <div class="relative w-full aspect-video bg-black shadow-2xl" id="image-preview-container">
                <img id="captured-image" class="w-full h-full object-cover opacity-80" src="" alt="Captura">
                <div id="box-overlay" class="absolute inset-0"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent to-transparent"></div>
            </div>

            <!-- Painel de Informação -->
            <div class="px-6 -mt-10 relative z-10 space-y-6">
                <div class="bg-slate-900/90 backdrop-blur-xl rounded-3xl p-6 border border-slate-800 shadow-2xl">
                    <span class="text-blue-400 text-[10px] font-black uppercase tracking-[0.3em]">Análise de Matéria</span>
                    <h2 id="result-name" class="text-3xl font-black mt-1 text-white leading-none">---</h2>
                    <p id="result-summary" class="text-slate-400 mt-3 text-xs leading-relaxed">Aguardando dados...</p>
                </div>

                <!-- Tabs -->
                <div class="flex p-1 bg-slate-900 rounded-2xl border border-slate-800">
                    <button id="tab-chemistry" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs flex items-center justify-center gap-2">
                        <i data-lucide="atom" class="w-4 h-4"></i> QUÍMICA
                    </button>
                    <button id="tab-spatial" class="flex-1 py-3 rounded-xl text-slate-400 font-bold text-xs flex items-center justify-center gap-2">
                        <i data-lucide="ruler" class="w-4 h-4"></i> ESPACIAL
                    </button>
                </div>

                <!-- Conteúdo Químico -->
                <div id="content-chemistry" class="space-y-2">
                    <div id="elements-list" class="grid gap-2 pb-4"></div>
                </div>

                <!-- Conteúdo Espacial -->
                <div id="content-spatial" class="hidden space-y-3">
                    <div class="bg-slate-900/60 border border-slate-800 p-5 rounded-2xl space-y-4 shadow-inner">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-black/40 p-3 rounded-2xl border border-slate-800">
                                <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-1">Largura</p>
                                <p id="spatial-width" class="text-lg font-black text-white">--</p>
                            </div>
                            <div class="bg-black/40 p-3 rounded-2xl border border-slate-800">
                                <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-1">Altura</p>
                                <p id="spatial-height" class="text-lg font-black text-white">--</p>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-slate-800">
                            <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-3">Relações Espaciais</p>
                            <ul id="distances-list" class="space-y-3 text-[11px] text-slate-300"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botão Fixo de Nova Análise -->
            <div class="fixed bottom-6 left-6 right-6 z-50">
                <button id="new-analysis-btn" class="w-full py-5 bg-blue-600 hover:bg-blue-500 text-white font-black text-sm uppercase tracking-widest rounded-2xl shadow-2xl shadow-blue-900/40 active:scale-95 transition-all">
                    REINICIAR SENSORES
                </button>
            </div>
        </div>

        <!-- Hidden canvas for image capture -->
        <canvas id="canvas" class="hidden"></canvas>
    </main>

    <!-- Overlay Loader -->
    <div id="analysis-loader" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex flex-col items-center justify-center p-10 text-center">
        <div class="w-16 h-16 border-2 border-blue-500/20 border-t-blue-500 rounded-full animate-spin"></div>
        <p class="mt-6 text-xs font-black text-blue-500 uppercase tracking-[0.3em] animate-pulse">Sincronizando Rede Atómica</p>
    </div>

    <!-- Modal de Erro -->
    <div id="error-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-8 bg-black/95">
        <div class="bg-slate-900 border border-red-500/20 p-8 rounded-3xl max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-circle" class="w-8 h-8 text-red-500"></i>
            </div>
            <h3 class="font-black text-lg text-white mb-2">Erro de Leitura</h3>
            <p id="error-message" class="text-slate-400 text-sm mb-8 leading-relaxed">Falha ao processar o frame.</p>
            <button id="error-close-btn" class="w-full py-4 bg-white text-black rounded-2xl font-black active:scale-95 transition-all">
                TENTAR NOVAMENTE
            </button>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let stream = null;
        let isScanning = false;
        let scanProgress = 0;
        let scanInterval = null;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const setupView = document.getElementById('setup-view');
        const cameraView = document.getElementById('camera-view');
        const resultsView = document.getElementById('results-view');
        const analysisLoader = document.getElementById('analysis-loader');
        const errorModal = document.getElementById('error-modal');
        const boxOverlay = document.getElementById('box-overlay');
        const capturedImage = document.getElementById('captured-image');
        const statusText = document.getElementById('status-text');
        
        lucide.createIcons();

        async function startCamera() {
            setupView.classList.add('hidden');
            cameraView.classList.remove('hidden');
            try {
                const constraints = { 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }, 
                    audio: false 
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.play();
            } catch (err) {
                showError("Acesso à câmara negado ou hardware indisponível.");
            }
        }

        function captureFrame() {
            if (video.readyState < 2) return null;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        function startScan(e) {
            if (isScanning || resultsView.offsetParent !== null || !stream) return;
            isScanning = true;
            scanProgress = 0;
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('scan-frame').classList.add('scan-frame-active');
            statusText.innerText = "Escaner Ativo - Aguarde";

            scanInterval = setInterval(() => {
                scanProgress += 5;
                document.getElementById('progress-bar').style.width = `${scanProgress}%`;
                if (scanProgress >= 100) stopScan(true);
            }, 100);
        }

        function stopScan(completed = false) {
            clearInterval(scanInterval);
            isScanning = false;
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('scan-frame').classList.remove('scan-frame-active');
            statusText.innerText = "Pressione e segure para escanear";
            if (completed) processAnalysis();
        }

        async function processAnalysis() {
            const imageData = captureFrame();
            if (!imageData) return;

            analysisLoader.classList.remove('hidden');
            capturedImage.src = imageData;

            const prompt = `Analise este frame e forneça dados químicos e espaciais.
            Retorne OBRIGATORIAMENTE um JSON:
            {
              "name": "Nome do Objeto Principal",
              "summary": "Resumo",
              "elements": [{"element": "Nome", "symbol": "X", "percentage": "Y%", "description": "Z"}],
              "spatial": {
                "width": "cm/m",
                "height": "cm/m",
                "objects": [{"label": "Nome", "box_2d": [ymin, xmin, ymax, xmax]}],
                "distances": ["Texto curto"]
              }
            }`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: imageData.split(',')[1] } }
                            ]
                        }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                
                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                displayResults(result);
            } catch (err) {
                showError("Erro na análise atómica e espacial. Tente aproximar o objeto.");
            } finally {
                analysisLoader.classList.add('hidden');
            }
        }

        function displayResults(data) {
            cameraView.classList.add('hidden');
            resultsView.classList.remove('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');

            document.getElementById('result-name').innerText = data.name;
            document.getElementById('result-summary').innerText = data.summary;
            document.getElementById('spatial-width').innerText = data.spatial.width || "---";
            document.getElementById('spatial-height').innerText = data.spatial.height || "---";

            // Bounding Boxes
            boxOverlay.innerHTML = '';
            if (data.spatial.objects) {
                data.spatial.objects.forEach(obj => {
                    const [ymin, xmin, ymax, xmax] = obj.box_2d;
                    const box = document.createElement('div');
                    box.className = 'bounding-box';
                    box.style.top = `${ymin / 10}%`;
                    box.style.left = `${xmin / 10}%`;
                    box.style.width = `${(xmax - xmin) / 10}%`;
                    box.style.height = `${(ymax - ymin) / 10}%`;
                    box.innerHTML = `<span class="box-label">${obj.label}</span>`;
                    boxOverlay.appendChild(box);
                });
            }

            // Química
            const elList = document.getElementById('elements-list');
            elList.innerHTML = '';
            data.elements.forEach(el => {
                const item = document.createElement('div');
                item.className = "bg-slate-900 border border-slate-800 p-4 rounded-2xl flex items-center gap-4";
                item.innerHTML = `
                    <div class="w-12 h-12 bg-blue-600/20 text-blue-400 border border-blue-500/30 rounded-xl flex items-center justify-center font-black">${el.symbol}</div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center"><h4 class="font-bold text-white text-sm">${el.element}</h4><span class="text-[10px] font-bold text-blue-500">${el.percentage}</span></div>
                        <p class="text-[10px] text-slate-500 mt-0.5 line-clamp-1">${el.description}</p>
                    </div>
                `;
                elList.appendChild(item);
            });

            // Distâncias
            const distList = document.getElementById('distances-list');
            distList.innerHTML = '';
            data.spatial.distances.forEach(d => {
                const li = document.createElement('li');
                li.className = "flex items-start gap-3 p-3 bg-black/20 rounded-xl border border-white/5";
                li.innerHTML = `<i data-lucide="info" class="w-3 h-3 mt-0.5 text-blue-400 shrink-0"></i> <span>${d}</span>`;
                distList.appendChild(li);
            });
            lucide.createIcons();
        }

        function toggleTab(type) {
            const isChem = type === 'chemistry';
            document.getElementById('content-chemistry').classList.toggle('hidden', !isChem);
            document.getElementById('content-spatial').classList.toggle('hidden', isChem);
            
            document.getElementById('tab-chemistry').className = isChem ? 
                "flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs flex items-center justify-center gap-2" :
                "flex-1 py-3 rounded-xl text-slate-400 font-bold text-xs flex items-center justify-center gap-2";
            document.getElementById('tab-spatial').className = !isChem ? 
                "flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs flex items-center justify-center gap-2" :
                "flex-1 py-3 rounded-xl text-slate-400 font-bold text-xs flex items-center justify-center gap-2";
        }

        document.getElementById('tab-chemistry').onclick = () => toggleTab('chemistry');
        document.getElementById('tab-spatial').onclick = () => toggleTab('spatial');

        function showError(msg) {
            document.getElementById('error-message').innerText = msg;
            errorModal.classList.remove('hidden');
        }

        function reset() {
            resultsView.classList.add('hidden');
            cameraView.classList.remove('hidden');
            document.getElementById('reset-btn').classList.add('hidden');
            toggleTab('chemistry');
        }

        document.getElementById('start-camera-btn').onclick = startCamera;
        document.getElementById('new-analysis-btn').onclick = reset;
        document.getElementById('reset-btn').onclick = reset;
        document.getElementById('error-close-btn').onclick = () => { errorModal.classList.add('hidden'); reset(); };

        // Suporte para Mouse e Toque (100% da área do vídeo)
        const interactionZone = document.getElementById('video');
        interactionZone.addEventListener('touchstart', (e) => { e.preventDefault(); startScan(); }, {passive:false});
        interactionZone.addEventListener('touchend', stopScan);
        interactionZone.addEventListener('mousedown', startScan);
        interactionZone.addEventListener('mouseup', stopScan);
    </script>
</body>
</html>

        .box-label {
            background: #3b82f6;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 0 0 4px 0;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="p-4 bg-slate-900/95 backdrop-blur-xl border-b border-slate-800 flex items-center justify-between z-50">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg">
                <i data-lucide="ruler" class="text-white w-6 h-6"></i>
            </div>
            <h1 class="font-bold text-xl tracking-tight text-white">ChemScan <span class="text-blue-500 font-light text-sm">SPATIAL</span></h1>
        </div>
        <button id="reset-btn" class="hidden p-2 bg-slate-800 rounded-full active:scale-90 transition-transform">
            <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-300"></i>
        </button>
    </header>

    <!-- Conteúdo Principal -->
    <main class="flex-1 relative flex flex-col bg-black overflow-hidden">
        
        <!-- Tela de Ativação -->
        <div id="setup-view" class="flex-1 flex flex-col items-center justify-center p-10 text-center space-y-8 bg-slate-950 z-40">
            <div class="p-8 rounded-full bg-slate-900 border-4 border-blue-500/30 animate-pulse">
                <i data-lucide="maximize" class="w-12 h-12 text-blue-500"></i>
            </div>
            <div class="space-y-4">
                <h2 class="text-2xl font-black text-white">Pronto para Medir</h2>
                <p class="text-slate-400 text-sm max-w-xs mx-auto leading-relaxed">
                    Aponte para objetos para medir dimensões, distâncias e analisar a composição química simultaneamente.
                </p>
            </div>
            <button id="start-camera-btn" class="w-full max-w-xs py-5 bg-blue-600 hover:bg-blue-500 text-white font-black text-lg rounded-2xl shadow-2xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                <i data-lucide="camera" class="w-6 h-6"></i>
                LIGAR SENSORES
            </button>
        </div>

        <!-- Visualização da Câmara -->
        <div id="camera-view" class="hidden relative flex-1">
            <video id="video" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover z-10"></video>
            
            <!-- Interface de Scan -->
            <div class="absolute inset-0 z-20 pointer-events-none flex flex-col items-center justify-center">
                <div id="scan-frame" class="w-72 h-72 border-2 border-white/20 rounded-[2.5rem] transition-all duration-300 flex items-center justify-center relative">
                    <i data-lucide="scan" id="scan-icon" class="text-white/20 w-10 h-10"></i>
                    
                    <!-- Cantos Estilizados -->
                    <div class="absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-blue-500/40 rounded-tl-[2.5rem]"></div>
                    <div class="absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-blue-500/40 rounded-br-[2.5rem]"></div>
                </div>

                <div class="mt-12 text-center">
                    <div class="bg-black/40 backdrop-blur-md px-6 py-2 rounded-full border border-white/10">
                        <p id="status-text" class="text-white font-bold text-xs uppercase tracking-widest">Segure na tela para escanear</p>
                    </div>
                </div>

                <!-- Barra de Progresso -->
                <div id="progress-container" class="hidden absolute bottom-20 left-10 right-10 h-1.5 bg-white/10 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-blue-500 w-0"></div>
                </div>
            </div>
        </div>

        <!-- Visualização de Resultados -->
        <div id="results-view" class="hidden flex-1 overflow-y-auto p-4 space-y-4 bg-slate-950 no-scrollbar pb-32">
            
            <!-- Preview com Bounding Boxes -->
            <div class="relative w-full aspect-video bg-slate-900 rounded-3xl overflow-hidden border border-slate-800 shadow-2xl" id="image-preview-container">
                <img id="captured-image" class="w-full h-full object-cover" src="" alt="Captura">
                <div id="box-overlay" class="absolute inset-0"></div>
            </div>

            <!-- Dados Principais -->
            <div class="bg-slate-900 rounded-3xl p-6 border border-slate-800 shadow-lg">
                <span class="text-blue-500 text-[10px] font-black uppercase tracking-[0.3em]">Objeto Identificado</span>
                <h2 id="result-name" class="text-3xl font-black mt-1 text-white leading-none">---</h2>
                <p id="result-summary" class="text-slate-400 mt-3 text-sm leading-relaxed">A processar...</p>
            </div>

            <!-- Tabs de Análise -->
            <div class="grid grid-cols-2 gap-2 bg-slate-900/50 p-1 rounded-2xl border border-slate-800">
                <button id="tab-chemistry" class="py-3 px-4 rounded-xl bg-blue-600 text-white font-bold text-xs flex items-center justify-center gap-2">
                    <i data-lucide="atom" class="w-4 h-4"></i> QUÍMICA
                </button>
                <button id="tab-spatial" class="py-3 px-4 rounded-xl text-slate-400 hover:text-white font-bold text-xs flex items-center justify-center gap-2">
                    <i data-lucide="ruler" class="w-4 h-4"></i> ESPACIAL
                </button>
            </div>

            <!-- Conteúdo Química -->
            <div id="content-chemistry" class="space-y-3">
                <div id="elements-list" class="grid gap-2"></div>
            </div>

            <!-- Conteúdo Espacial -->
            <div id="content-spatial" class="hidden space-y-3">
                <div class="bg-slate-900/40 border border-slate-800 p-5 rounded-2xl space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-slate-500 font-bold uppercase">Dimensões Reais (Est.)</span>
                        <i data-lucide="maximize-2" class="w-4 h-4 text-blue-400"></i>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                            <p class="text-[10px] text-slate-500 font-bold">LARGURA</p>
                            <p id="spatial-width" class="text-xl font-black text-white">--</p>
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                            <p class="text-[10px] text-slate-500 font-bold">ALTURA</p>
                            <p id="spatial-height" class="text-xl font-black text-white">--</p>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-slate-800">
                        <p class="text-[10px] text-slate-500 font-bold mb-2">DISTÂNCIAS NO CENÁRIO</p>
                        <ul id="distances-list" class="space-y-2 text-sm text-slate-300">
                            <!-- Injetado aqui -->
                        </ul>
                    </div>
                </div>
            </div>

            <div class="fixed bottom-6 left-6 right-6 z-50">
                <button id="new-analysis-btn" class="w-full py-5 bg-white text-black font-black text-lg rounded-2xl shadow-2xl active:scale-95 transition-all">
                    NOVA ANÁLISE
                </button>
            </div>
        </div>

        <!-- Hidden canvas for image capture -->
        <canvas id="canvas" class="hidden"></canvas>
    </main>

    <!-- Overlay Loader -->
    <div id="analysis-loader" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex flex-col items-center justify-center p-10 text-center">
        <div class="w-20 h-20 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin"></div>
        <h3 class="mt-8 text-xl font-black text-white">Sincronizando Sensores</h3>
        <p class="mt-2 text-slate-400 text-sm">Calculando distâncias e composição atómica...</p>
    </div>

    <!-- Erro -->
    <div id="error-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-6 bg-black/95">
        <div class="bg-slate-900 border border-red-500/30 p-8 rounded-[2rem] max-w-sm w-full shadow-2xl">
            <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mb-4 mx-auto"></i>
            <h3 class="font-black text-xl text-center mb-2">Falha na Leitura</h3>
            <p id="error-message" class="text-slate-400 text-sm text-center mb-8">Erro inesperado.</p>
            <button id="error-close-btn" class="w-full py-4 bg-red-600/10 text-red-500 rounded-2xl font-black border border-red-500/20 active:scale-95">
                REINICIAR
            </button>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let stream = null;
        let isScanning = false;
        let scanProgress = 0;
        let scanInterval = null;

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const setupView = document.getElementById('setup-view');
        const cameraView = document.getElementById('camera-view');
        const resultsView = document.getElementById('results-view');
        const analysisLoader = document.getElementById('analysis-loader');
        const errorModal = document.getElementById('error-modal');
        const boxOverlay = document.getElementById('box-overlay');
        const capturedImage = document.getElementById('captured-image');
        
        lucide.createIcons();

        async function startCamera() {
            setupView.classList.add('hidden');
            cameraView.classList.remove('hidden');
            try {
                const constraints = { video: { facingMode: 'environment' }, audio: false };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
            } catch (err) {
                showError("Permissão de câmara negada.");
            }
        }

        function captureFrame() {
            if (video.readyState < 2) return null;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        function startScan(e) {
            if (isScanning || resultsView.offsetParent !== null || !stream) return;
            isScanning = true;
            scanProgress = 0;
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('scan-frame').classList.add('scan-frame-active');

            scanInterval = setInterval(() => {
                scanProgress += 5;
                document.getElementById('progress-bar').style.width = `${scanProgress}%`;
                if (scanProgress >= 100) stopScan(true);
            }, 100);
        }

        function stopScan(completed = false) {
            clearInterval(scanInterval);
            isScanning = false;
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('scan-frame').classList.remove('scan-frame-active');
            if (completed) processAnalysis();
        }

        async function processAnalysis() {
            const imageData = captureFrame();
            if (!imageData) return;

            analysisLoader.classList.remove('hidden');
            capturedImage.src = imageData;

            const prompt = `Analise este frame e forneça dados químicos e espaciais.
            Retorne OBRIGATORIAMENTE um JSON:
            {
              "name": "Nome do Objeto Principal",
              "summary": "Resumo",
              "elements": [{"element": "Nome", "symbol": "X", "percentage": "Y%", "description": "Z"}],
              "spatial": {
                "width": "cm ou m",
                "height": "cm ou m",
                "objects": [{"label": "Nome", "box_2d": [ymin, xmin, ymax, xmax], "distance_to_center": "valor"}],
                "distances": ["Texto descrevendo distância entre objeto A e B"]
              }
            }`;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: imageData.split(',')[1] } }
                    ]
                }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                displayResults(result);
            } catch (err) {
                showError("Erro na análise atómica e espacial.");
            } finally {
                analysisLoader.classList.add('hidden');
            }
        }

        function displayResults(data) {
            cameraView.classList.add('hidden');
            resultsView.classList.remove('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');

            document.getElementById('result-name').innerText = data.name;
            document.getElementById('result-summary').innerText = data.summary;
            document.getElementById('spatial-width').innerText = data.spatial.width;
            document.getElementById('spatial-height').innerText = data.spatial.height;

            // Desenhar Bounding Boxes
            boxOverlay.innerHTML = '';
            if (data.spatial.objects) {
                data.spatial.objects.forEach(obj => {
                    const [ymin, xmin, ymax, xmax] = obj.box_2d;
                    const box = document.createElement('div');
                    box.className = 'bounding-box';
                    box.style.top = `${ymin / 10}%`;
                    box.style.left = `${xmin / 10}%`;
                    box.style.width = `${(xmax - xmin) / 10}%`;
                    box.style.height = `${(ymax - ymin) / 10}%`;
                    box.innerHTML = `<span class="box-label">${obj.label}</span>`;
                    boxOverlay.appendChild(box);
                });
            }

            // Lista Quimica
            const elList = document.getElementById('elements-list');
            elList.innerHTML = '';
            data.elements.forEach(el => {
                const item = document.createElement('div');
                item.className = "bg-slate-900 border border-slate-800 p-4 rounded-2xl flex items-center gap-4";
                item.innerHTML = `
                    <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center font-black">${el.symbol}</div>
                    <div><h4 class="font-bold text-white">${el.element} (${el.percentage})</h4><p class="text-[10px] text-slate-500">${el.description}</p></div>
                `;
                elList.appendChild(item);
            });

            // Distâncias
            const distList = document.getElementById('distances-list');
            distList.innerHTML = '';
            data.spatial.distances.forEach(d => {
                const li = document.createElement('li');
                li.className = "flex items-start gap-2 italic";
                li.innerHTML = `<i data-lucide="arrow-right-left" class="w-3 h-3 mt-1 text-blue-400"></i> ${d}`;
                distList.appendChild(li);
            });
            lucide.createIcons();
        }

        // Tabs
        document.getElementById('tab-chemistry').onclick = () => {
            toggleTab('chemistry');
        };
        document.getElementById('tab-spatial').onclick = () => {
            toggleTab('spatial');
        };

        function toggleTab(type) {
            const isChem = type === 'chemistry';
            document.getElementById('content-chemistry').classList.toggle('hidden', !isChem);
            document.getElementById('content-spatial').classList.toggle('hidden', isChem);
            document.getElementById('tab-chemistry').className = isChem ? 
                "py-3 px-4 rounded-xl bg-blue-600 text-white font-bold text-xs flex items-center justify-center gap-2" :
                "py-3 px-4 rounded-xl text-slate-400 hover:text-white font-bold text-xs flex items-center justify-center gap-2";
            document.getElementById('tab-spatial').className = !isChem ? 
                "py-3 px-4 rounded-xl bg-blue-600 text-white font-bold text-xs flex items-center justify-center gap-2" :
                "py-3 px-4 rounded-xl text-slate-400 hover:text-white font-bold text-xs flex items-center justify-center gap-2";
        }

        function showError(msg) {
            document.getElementById('error-message').innerText = msg;
            errorModal.classList.remove('hidden');
        }

        function reset() {
            resultsView.classList.add('hidden');
            cameraView.classList.remove('hidden');
            document.getElementById('reset-btn').classList.add('hidden');
            toggleTab('chemistry');
        }

        document.getElementById('start-camera-btn').onclick = startCamera;
        document.getElementById('new-analysis-btn').onclick = reset;
        document.getElementById('reset-btn').onclick = reset;
        document.getElementById('error-close-btn').onclick = () => { errorModal.classList.add('hidden'); reset(); };

        video.addEventListener('touchstart', (e) => { if(e.cancelable) e.preventDefault(); startScan(); }, {passive:false});
        video.addEventListener('touchend', stopScan);
        video.addEventListener('mousedown', startScan);
        video.addEventListener('mouseup', stopScan);
    </script>
</body>
</html>

        <button id="reset-btn" class="hidden p-2 bg-slate-800 rounded-full active:scale-90 transition-transform">
            <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-300"></i>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative flex flex-col bg-black overflow-hidden">
        
        <!-- Camera Activation View -->
        <div id="setup-view" class="flex-1 flex flex-col items-center justify-center p-10 text-center space-y-8 bg-slate-950 z-40">
            <div class="p-8 rounded-full bg-slate-900 border-4 border-blue-500/30 animate-pulse">
                <i data-lucide="power" class="w-12 h-12 text-blue-500"></i>
            </div>
            <div class="space-y-4">
                <h2 class="text-2xl font-black text-white">Pronto para Iniciar</h2>
                <p class="text-slate-400 text-sm max-w-xs mx-auto leading-relaxed">
                    Clique no botão abaixo para ligar os sensores e começar a análise atómica de objetos em tempo real.
                </p>
            </div>
            <button id="start-camera-btn" class="w-full max-w-xs py-5 bg-blue-600 hover:bg-blue-500 text-white font-black text-lg rounded-2xl shadow-2xl shadow-blue-900/40 flex items-center justify-center gap-3 active:scale-95 transition-all">
                <i data-lucide="camera" class="w-6 h-6"></i>
                LIGAR CÂMARA
            </button>
        </div>

        <!-- Camera Viewport -->
        <div id="camera-view" class="hidden relative flex-1">
            <video id="video" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover z-10"></video>
            
            <!-- Scan Interface -->
            <div class="absolute inset-0 z-20 pointer-events-none flex flex-col items-center justify-center">
                <div id="scan-frame" class="w-72 h-72 border-2 border-white/20 rounded-[2.5rem] transition-all duration-300 flex items-center justify-center relative">
                    <i data-lucide="scan" id="scan-icon" class="text-white/20 w-10 h-10 transition-all"></i>
                    
                    <!-- Corner Accents -->
                    <div class="absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-blue-500/40 rounded-tl-[2.5rem]"></div>
                    <div class="absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-blue-500/40 rounded-br-[2.5rem]"></div>
                </div>

                <div class="mt-12 text-center">
                    <div id="status-container" class="bg-black/40 backdrop-blur-md px-6 py-2 rounded-full border border-white/10">
                        <p id="status-text" class="text-white font-bold text-xs uppercase tracking-widest">Segure na tela para escanear</p>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="progress-container" class="hidden absolute bottom-20 left-10 right-10 h-1.5 bg-white/10 rounded-full overflow-hidden backdrop-blur-sm border border-white/5">
                    <div id="progress-bar" class="h-full bg-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.8)] transition-all duration-100 w-0"></div>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="hidden flex-1 overflow-y-auto p-6 space-y-6 bg-slate-950 no-scrollbar pb-32">
            <div class="bg-slate-900 rounded-[2rem] p-8 border border-slate-800 relative overflow-hidden shadow-2xl">
                <div class="absolute top-0 right-0 p-4 opacity-5">
                    <i data-lucide="atom" class="w-24 h-24"></i>
                </div>
                <span class="text-blue-500 text-[10px] font-black uppercase tracking-[0.3em]">Análise de Espectro</span>
                <h2 id="result-name" class="text-4xl font-black mt-2 text-white leading-none">---</h2>
                <p id="result-summary" class="text-slate-400 mt-4 text-sm leading-relaxed font-medium italic">A carregar descrição...</p>
            </div>

            <div class="space-y-4">
                <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest ml-2">Composição Atómica</h3>
                <div id="elements-list" class="grid gap-3">
                    <!-- Element cards injected here -->
                </div>
            </div>

            <div class="fixed bottom-8 left-8 right-8 z-50">
                <button id="new-analysis-btn" class="w-full py-5 bg-white text-black font-black text-lg rounded-2xl shadow-2xl active:scale-95 transition-all">
                    NOVA ANÁLISE
                </button>
            </div>
        </div>

        <!-- Hidden canvas for image capture -->
        <canvas id="canvas" class="hidden"></canvas>
    </main>

    <!-- Overlay Loader -->
    <div id="analysis-loader" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex flex-col items-center justify-center p-10 text-center">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin"></div>
            <i data-lucide="search" class="absolute inset-0 m-auto w-8 h-8 text-blue-500 animate-pulse"></i>
        </div>
        <h3 class="mt-8 text-xl font-black text-white">Descodificando Matéria</h3>
        <p class="mt-2 text-slate-400 text-sm">Consultando base de dados atómica do Gemini...</p>
    </div>

    <!-- Error Toast -->
    <div id="error-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-6 bg-black/90 backdrop-blur-sm">
        <div class="bg-slate-900 border border-red-500/50 p-6 rounded-3xl max-w-sm w-full shadow-2xl">
            <div class="flex items-center gap-3 text-red-400 mb-4">
                <i data-lucide="alert-circle" class="w-6 h-6"></i>
                <h3 class="font-bold text-lg">Houve um erro</h3>
            </div>
            <p id="error-message" class="text-slate-300 text-sm mb-6 leading-relaxed">Ocorreu um problema ao analisar a imagem.</p>
            <button id="error-close-btn" class="w-full py-4 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors font-bold">
                Tentar novamente
            </button>
        </div>
    </div>

    <script>
        // Configuração
        const apiKey = ""; // Injetada pelo ambiente
        let stream = null;
        let isScanning = false;
        let scanProgress = 0;
        let scanInterval = null;

        // Elementos DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const setupView = document.getElementById('setup-view');
        const cameraView = document.getElementById('camera-view');
        const resultsView = document.getElementById('results-view');
        const analysisLoader = document.getElementById('analysis-loader');
        const errorModal = document.getElementById('error-modal');
        
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const scanFrame = document.getElementById('scan-frame');
        const scanIcon = document.getElementById('scan-icon');
        const statusText = document.getElementById('status-text');

        // Inicializar ícones
        lucide.createIcons();

        async function startCamera() {
            setupView.classList.add('hidden');
            cameraView.classList.remove('hidden');
            
            try {
                const constraints = {
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play().catch(e => showError("O vídeo não pôde ser iniciado. Recarregue a página."));
                };
            } catch (err) {
                console.error(err);
                showError("Erro de Permissão: Verifique se o navegador tem acesso à câmara nas definições do sistema.");
            }
        }

        function captureFrame() {
            if (video.readyState < 2) return null; // Garante que há vídeo pronto
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        function startScan(e) {
            if (isScanning || resultsView.offsetParent !== null || !stream) return;
            
            isScanning = true;
            scanProgress = 0;
            progressBar.style.width = '0%';
            progressContainer.classList.remove('hidden');
            scanFrame.classList.add('scan-frame-active');
            scanIcon.classList.add('text-blue-500', 'opacity-100');
            statusText.innerText = "A capturar espectro...";

            scanInterval = setInterval(() => {
                scanProgress += 5; // Acelerei um pouco para 2 segundos reais
                progressBar.style.width = `${scanProgress}%`;
                
                if (scanProgress >= 100) {
                    stopScan(true);
                }
            }, 100);
        }

        function stopScan(completed = false) {
            clearInterval(scanInterval);
            isScanning = false;
            
            if (!completed) {
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
                scanFrame.classList.remove('scan-frame-active');
                scanIcon.classList.remove('text-blue-500', 'opacity-100');
                statusText.innerText = "Segure na tela para escanear";
            } else {
                processAnalysis();
            }
        }

        async function processAnalysis() {
            const imageData = captureFrame();
            if (!imageData) {
                showError("A câmara não está a gerar imagem. Tente novamente.");
                return;
            }

            analysisLoader.classList.remove('hidden');

            const prompt = `Identifica o objeto principal nesta imagem e lista a sua composição química provável baseada na tabela periódica. 
            Retorna OBRIGATORIAMENTE apenas um objeto JSON válido.
            Formato:
            {
              "name": "Nome do objeto",
              "elements": [
                { "element": "Nome do Elemento", "symbol": "Símbolo", "percentage": "X%", "description": "Motivo" }
              ],
              "summary": "Resumo da composição"
            }`;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: imageData.split(',')[1] } }
                    ]
                }],
                generationConfig: { 
                    responseMimeType: "application/json" 
                }
            };

            try {
                const fetchWithRetry = async (retries = 3) => {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errBody = await response.text();
                        console.error("Erro API:", errBody);
                        if (retries > 0) {
                            await new Promise(r => setTimeout(r, 1000));
                            return fetchWithRetry(retries - 1);
                        }
                        throw new Error("Erro de Ligação");
                    }
                    return response.json();
                };

                const data = await fetchWithRetry();
                
                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error("Nenhum resultado");
                }

                let textResponse = data.candidates[0].content.parts[0].text;
                // Limpeza de blocos de código se a IA os tiver incluído por engano
                textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const result = JSON.parse(textResponse);
                displayResults(result);
            } catch (err) {
                console.error("Erro de Processamento:", err);
                showError("A análise falhou. Verifique a ligação à internet e certifique-se que o objeto está bem iluminado.");
            } finally {
                analysisLoader.classList.add('hidden');
                stopScan(false); // Reset visual
            }
        }

        function displayResults(data) {
            cameraView.classList.add('hidden');
            resultsView.classList.remove('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');

            document.getElementById('result-name').innerText = data.name || "Desconhecido";
            document.getElementById('result-summary').innerText = data.summary || "Sem descrição disponível.";

            const list = document.getElementById('elements-list');
            list.innerHTML = '';

            if (data.elements && Array.isArray(data.elements)) {
                data.elements.forEach((el, i) => {
                    const card = document.createElement('div');
                    card.className = "bg-slate-900/60 backdrop-blur-sm border border-slate-800 p-5 rounded-2xl flex items-center gap-5";
                    card.innerHTML = `
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl flex flex-col items-center justify-center shadow-lg shrink-0">
                            <span class="text-[10px] text-white/60 font-mono mb-1">${i+1}</span>
                            <span class="font-black text-2xl text-white">${el.symbol || '?'}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="font-bold text-slate-100 text-lg truncate">${el.element || '---'}</h4>
                                <span class="text-[11px] font-black text-blue-400 bg-blue-400/10 px-2 py-1 rounded-lg">${el.percentage || '-'}</span>
                            </div>
                            <p class="text-xs text-slate-500 leading-tight italic line-clamp-2">${el.description || ''}</p>
                        </div>
                    `;
                    list.appendChild(card);
                });
            }
        }

        function showError(msg) {
            document.getElementById('error-message').innerText = msg;
            errorModal.classList.remove('hidden');
        }

        function reset() {
            resultsView.classList.add('hidden');
            document.getElementById('reset-btn').classList.add('hidden');
            cameraView.classList.remove('hidden');
            stopScan();
        }

        // Listeners
        document.getElementById('start-camera-btn').addEventListener('click', startCamera);
        document.getElementById('new-analysis-btn').addEventListener('click', reset);
        document.getElementById('reset-btn').addEventListener('click', reset);
        document.getElementById('error-close-btn').addEventListener('click', () => {
            errorModal.classList.add('hidden');
            reset();
        });

        // Eventos de toque/rato no vídeo
        video.addEventListener('mousedown', startScan);
        video.addEventListener('mouseup', stopScan);
        video.addEventListener('touchstart', (e) => { 
            if (e.cancelable) e.preventDefault(); 
            startScan(); 
        }, { passive: false });
        video.addEventListener('touchend', stopScan);

    </script>
</body>
</html>

</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="p-4 bg-slate-900/95 backdrop-blur-xl border-b border-slate-800 flex items-center justify-between z-50">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-900/40">
                <i data-lucide="atom" class="text-white w-6 h-6"></i>
            </div>
            <h1 class="font-bold text-xl tracking-tight text-white">ChemScan <span class="text-blue-500 font-light text-sm">PRO</span></h1>
        </div>
        <button id="reset-btn" class="hidden p-2 bg-slate-800 rounded-full active:scale-90 transition-transform">
            <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-300"></i>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative flex flex-col bg-black overflow-hidden">
        
        <!-- Camera Activation View -->
        <div id="setup-view" class="flex-1 flex flex-col items-center justify-center p-10 text-center space-y-8 bg-slate-950 z-40">
            <div class="p-8 rounded-full bg-slate-900 border-4 border-blue-500/30 animate-pulse">
                <i data-lucide="power" class="w-12 h-12 text-blue-500"></i>
            </div>
            <div class="space-y-4">
                <h2 class="text-2xl font-black text-white">Pronto para Iniciar</h2>
                <p class="text-slate-400 text-sm max-w-xs mx-auto leading-relaxed">
                    Clique no botão abaixo para ligar os sensores e começar a análise atómica de objetos em tempo real.
                </p>
            </div>
            <button id="start-camera-btn" class="w-full max-w-xs py-5 bg-blue-600 hover:bg-blue-500 text-white font-black text-lg rounded-2xl shadow-2xl shadow-blue-900/40 flex items-center justify-center gap-3 active:scale-95 transition-all">
                <i data-lucide="camera" class="w-6 h-6"></i>
                LIGAR CÂMARA
            </button>
        </div>

        <!-- Camera Viewport -->
        <div id="camera-view" class="hidden relative flex-1">
            <video id="video" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover z-10"></video>
            
            <!-- Scan Interface -->
            <div class="absolute inset-0 z-20 pointer-events-none flex flex-col items-center justify-center">
                <div id="scan-frame" class="w-72 h-72 border-2 border-white/20 rounded-[2.5rem] transition-all duration-300 flex items-center justify-center relative">
                    <i data-lucide="scan" id="scan-icon" class="text-white/20 w-10 h-10 transition-all"></i>
                    
                    <!-- Corner Accents -->
                    <div class="absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-blue-500/40 rounded-tl-[2.5rem]"></div>
                    <div class="absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-blue-500/40 rounded-br-[2.5rem]"></div>
                </div>

                <div class="mt-12 text-center">
                    <div id="status-container" class="bg-black/40 backdrop-blur-md px-6 py-2 rounded-full border border-white/10">
                        <p id="status-text" class="text-white font-bold text-xs uppercase tracking-widest">Segure na tela para escanear</p>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="progress-container" class="hidden absolute bottom-20 left-10 right-10 h-1.5 bg-white/10 rounded-full overflow-hidden backdrop-blur-sm border border-white/5">
                    <div id="progress-bar" class="h-full bg-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.8)] transition-all duration-100 w-0"></div>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="hidden flex-1 overflow-y-auto p-6 space-y-6 bg-slate-950 no-scrollbar pb-32">
            <div class="bg-slate-900 rounded-[2rem] p-8 border border-slate-800 relative overflow-hidden shadow-2xl">
                <div class="absolute top-0 right-0 p-4 opacity-5">
                    <i data-lucide="atom" class="w-24 h-24"></i>
                </div>
                <span class="text-blue-500 text-[10px] font-black uppercase tracking-[0.3em]">Análise de Espectro</span>
                <h2 id="result-name" class="text-4xl font-black mt-2 text-white leading-none">---</h2>
                <p id="result-summary" class="text-slate-400 mt-4 text-sm leading-relaxed font-medium italic">A carregar descrição...</p>
            </div>

            <div class="space-y-4">
                <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest ml-2">Composição Atómica</h3>
                <div id="elements-list" class="grid gap-3">
                    <!-- Element cards injected here -->
                </div>
            </div>

            <div class="fixed bottom-8 left-8 right-8 z-50">
                <button id="new-analysis-btn" class="w-full py-5 bg-white text-black font-black text-lg rounded-2xl shadow-2xl active:scale-95 transition-all">
                    NOVA ANÁLISE
                </button>
            </div>
        </div>

        <!-- Hidden canvas for image capture -->
        <canvas id="canvas" class="hidden"></canvas>
    </main>

    <!-- Overlay Loader -->
    <div id="analysis-loader" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex flex-col items-center justify-center p-10 text-center">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin"></div>
            <i data-lucide="search" class="absolute inset-0 m-auto w-8 h-8 text-blue-500 animate-pulse"></i>
        </div>
        <h3 class="mt-8 text-xl font-black text-white">Descodificando Matéria</h3>
        <p class="mt-2 text-slate-400 text-sm">Consultando base de dados atómica do Gemini...</p>
    </div>

    <!-- Error Toast -->
    <div id="error-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-6 bg-black/90 backdrop-blur-sm">
        <div class="bg-slate-900 border border-red-500/50 p-6 rounded-3xl max-w-sm w-full shadow-2xl">
            <div class="flex items-center gap-3 text-red-400 mb-4">
                <i data-lucide="alert-circle" class="w-6 h-6"></i>
                <h3 class="font-bold text-lg">Houve um erro</h3>
            </div>
            <p id="error-message" class="text-slate-300 text-sm mb-6 leading-relaxed">Não foi possível aceder à câmara.</p>
            <button id="error-close-btn" class="w-full py-4 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors font-bold">
                Tentar novamente
            </button>
        </div>
    </div>

    <script>
        // Configuração
        const apiKey = ""; // Injetada pelo ambiente
        let stream = null;
        let isScanning = false;
        let scanProgress = 0;
        let scanInterval = null;

        // Elementos DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const setupView = document.getElementById('setup-view');
        const cameraView = document.getElementById('camera-view');
        const resultsView = document.getElementById('results-view');
        const analysisLoader = document.getElementById('analysis-loader');
        const errorModal = document.getElementById('error-modal');
        
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const scanFrame = document.getElementById('scan-frame');
        const scanIcon = document.getElementById('scan-icon');
        const statusText = document.getElementById('status-text');

        // Inicializar ícones
        lucide.createIcons();

        // Funções de Câmara
        async function startCamera() {
            setupView.classList.add('hidden');
            cameraView.classList.remove('hidden');
            
            try {
                const constraints = {
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play().catch(e => showError("Erro ao iniciar reprodução de vídeo."));
                };
            } catch (err) {
                console.error(err);
                showError("Não foi possível aceder à câmara traseira. Verifique as permissões do navegador.");
            }
        }

        function captureFrame() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        // Lógica de Scan (Segurar)
        function startScan() {
            if (isScanning || resultsView.offsetParent !== null) return;
            
            isScanning = true;
            scanProgress = 0;
            progressBar.style.width = '0%';
            progressContainer.classList.remove('hidden');
            scanFrame.classList.add('scan-frame-active');
            scanIcon.classList.add('text-blue-500', 'opacity-100');
            statusText.innerText = "A escanear matéria...";

            scanInterval = setInterval(() => {
                scanProgress += 4;
                progressBar.style.width = `${scanProgress}%`;
                
                if (scanProgress >= 100) {
                    stopScan(true);
                }
            }, 80); // ~2 segundos
        }

        function stopScan(completed = false) {
            clearInterval(scanInterval);
            isScanning = false;
            
            if (!completed) {
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
                scanFrame.classList.remove('scan-frame-active');
                scanIcon.classList.remove('text-blue-500', 'opacity-100');
                statusText.innerText = "Segure na tela para escanear";
            } else {
                processAnalysis();
            }
        }

        async function processAnalysis() {
            const imageData = captureFrame();
            analysisLoader.classList.remove('hidden');

            const prompt = `Identifica o objeto principal nesta imagem e lista a sua composição química provável baseada na tabela periódica. 
            Retorna os dados em formato JSON estrito com as seguintes propriedades:
            - name: nome do objeto
            - elements: um array de objetos com { element: "Nome do Elemento", symbol: "Símbolo", percentage: "Percentagem estimada ou 'Traços'", description: "Por que motivo este elemento está presente?" }
            - summary: uma breve descrição da composição geral.`;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: imageData.split(',')[1] } }
                    ]
                }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                // Implementação de fetch com retry básico
                const fetchWithRetry = async (retries = 3) => {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        if (retries > 0) return fetchWithRetry(retries - 1);
                        throw new Error("Falha na API");
                    }
                    return response.json();
                };

                const data = await fetchWithRetry();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                displayResults(result);
            } catch (err) {
                showError("A IA não conseguiu analisar esta imagem. Tente focar melhor o objeto.");
            } finally {
                analysisLoader.classList.add('hidden');
            }
        }

        function displayResults(data) {
            cameraView.classList.add('hidden');
            resultsView.classList.remove('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');

            document.getElementById('result-name').innerText = data.name;
            document.getElementById('result-summary').innerText = data.summary;

            const list = document.getElementById('elements-list');
            list.innerHTML = '';

            data.elements.forEach((el, i) => {
                const card = document.createElement('div');
                card.className = "bg-slate-900/60 backdrop-blur-sm border border-slate-800 p-5 rounded-2xl flex items-center gap-5";
                card.innerHTML = `
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl flex flex-col items-center justify-center shadow-lg shrink-0">
                        <span class="text-[10px] text-white/60 font-mono mb-1">${i+1}</span>
                        <span class="font-black text-2xl text-white">${el.symbol}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-slate-100 text-lg truncate">${el.element}</h4>
                            <span class="text-[11px] font-black text-blue-400 bg-blue-400/10 px-2 py-1 rounded-lg">${el.percentage}</span>
                        </div>
                        <p class="text-xs text-slate-500 leading-tight italic line-clamp-2">${el.description}</p>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function showError(msg) {
            document.getElementById('error-message').innerText = msg;
            errorModal.classList.remove('hidden');
        }

        function reset() {
            resultsView.classList.add('hidden');
            document.getElementById('reset-btn').classList.add('hidden');
            cameraView.classList.remove('hidden');
            stopScan();
        }

        // Listeners
        document.getElementById('start-camera-btn').addEventListener('click', startCamera);
        document.getElementById('new-analysis-btn').addEventListener('click', reset);
        document.getElementById('reset-btn').addEventListener('click', reset);
        document.getElementById('error-close-btn').addEventListener('click', () => errorModal.classList.add('hidden'));

        // Eventos de toque no vídeo
        video.addEventListener('mousedown', startScan);
        video.addEventListener('mouseup', stopScan);
        video.addEventListener('touchstart', (e) => { e.preventDefault(); startScan(); });
        video.addEventListener('touchend', stopScan);

    </script>
</body>
</html>




