import React, { useState, useEffect, useRef } from 'react';
import { Camera, RefreshCw, Atom, Info, AlertCircle, Loader2, Scan, ShieldCheck, Power } from 'lucide-react';

const apiKey = ""; // A chave é injetada automaticamente pelo ambiente

const App = () => {
  const [stream, setStream] = useState(null);
  const [scanning, setScanning] = useState(false);
  const [progress, setProgress] = useState(0);
  const [result, setResult] = useState(null);
  const [error, setError] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [cameraStatus, setCameraStatus] = useState('idle'); // 'idle', 'loading', 'ready', 'denied'

  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const timerRef = useRef(null);

  // Tenta iniciar a câmara com diferentes níveis de restrição
  const startCamera = async () => {
    setCameraStatus('loading');
    setError(null);
    
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }

    // Tentativa 1: Câmara Traseira
    // Tentativa 2: Qualquer câmara (fallback)
    const attemptStream = async (constraints) => {
      try {
        return await navigator.mediaDevices.getUserMedia(constraints);
      } catch (e) {
        return null;
      }
    };

    let mediaStream = await attemptStream({ video: { facingMode: 'environment' }, audio: false });
    
    if (!mediaStream) {
      mediaStream = await attemptStream({ video: true, audio: false });
    }

    if (mediaStream) {
      setStream(mediaStream);
      if (videoRef.current) {
        videoRef.current.srcObject = mediaStream;
        
        // Pequeno delay para garantir que o elemento está pronto
        setTimeout(() => {
          if (videoRef.current) {
            videoRef.current.play()
              .then(() => setCameraStatus('ready'))
              .catch(err => {
                console.error("Erro no play:", err);
                setError("O vídeo foi bloqueado pelo navegador. Toque novamente para tentar forçar a exibição.");
                setCameraStatus('denied');
              });
          }
        }, 300);
      }
    } else {
      setCameraStatus('denied');
      setError("Não foi possível aceder a nenhuma câmara. Verifique se o seu navegador tem permissão nas definições do sistema.");
    }
  };

  useEffect(() => {
    // Não iniciamos automaticamente para evitar bloqueios de autoplay
    return () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    };
  }, []);

  const analyzeImage = async (base64Image) => {
    setIsLoading(true);
    setScanning(false);
    setProgress(0);

    const prompt = `Identifica o objeto principal nesta imagem e lista a sua composição química provável baseada na tabela periódica. 
    Retorna os dados em formato JSON estrito com as seguintes propriedades:
    - name: nome do objeto
    - elements: um array de objetos com { element: "Nome do Elemento", symbol: "Símbolo", percentage: "Percentagem estimada ou 'Traços'", description: "Por que motivo este elemento está presente?" }
    - summary: uma breve descrição da composição geral.`;

    const payload = {
      contents: [{
        parts: [
          { text: prompt },
          { inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } }
        ]
      }],
      generationConfig: {
        responseMimeType: "application/json"
      }
    };

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error('Falha na API');
      const data = await response.json();
      const finalResult = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
      if (!finalResult.name) throw new Error("Resposta inválida");
      setResult(finalResult);
    } catch (err) {
      setError("A IA não conseguiu processar esta imagem. Tente uma foto mais nítida.");
    } finally {
      setIsLoading(false);
    }
  };

  const captureFrame = () => {
    if (videoRef.current && canvasRef.current) {
      const context = canvasRef.current.getContext('2d');
      // Captura na resolução real do vídeo
      canvasRef.current.width = videoRef.current.videoWidth;
      canvasRef.current.height = videoRef.current.videoHeight;
      context.drawImage(videoRef.current, 0, 0);
      return canvasRef.current.toDataURL('image/jpeg', 0.8);
    }
    return null;
  };

  const startScanning = (e) => {
    if (isLoading || result || cameraStatus !== 'ready') return;
    e.preventDefault(); // Evita scroll ao segurar
    setScanning(true);
    let currentProgress = 0;
    
    timerRef.current = setInterval(() => {
      currentProgress += 4;
      setProgress(currentProgress);
      
      if (currentProgress >= 100) {
        clearInterval(timerRef.current);
        const image = captureFrame();
        if (image) analyzeImage(image);
      }
    }, 80); // ~2 segundos
  };

  const stopScanning = () => {
    if (timerRef.current) {
      clearInterval(timerRef.current);
      setScanning(false);
      setProgress(0);
    }
  };

  const reset = () => {
    setResult(null);
    setError(null);
    setProgress(0);
    setScanning(false);
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 flex flex-col font-sans select-none overflow-hidden touch-none">
      {/* Header */}
      <header className="p-4 bg-slate-900/95 backdrop-blur-xl border-b border-slate-800 flex items-center justify-between z-50">
        <div className="flex items-center gap-2">
          <div className="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-900/40">
            <Atom size={24} className="text-white" />
          </div>
          <h1 className="font-bold text-xl tracking-tight">ChemScan <span className="text-blue-500 font-light">PRO</span></h1>
        </div>
        {result && (
          <button onClick={reset} className="p-2 bg-slate-800 rounded-full active:scale-90 transition-transform">
            <RefreshCw size={20} />
          </button>
        )}
      </header>

      {/* Viewport Principal */}
      <main className="flex-1 relative flex flex-col bg-black">
        {cameraStatus !== 'ready' && !result ? (
          <div className="flex-1 flex flex-col items-center justify-center p-10 text-center space-y-8 bg-slate-950">
            <div className={`p-8 rounded-full bg-slate-900 border-4 ${error ? 'border-red-500/50' : 'border-blue-500/30'} animate-pulse`}>
              {cameraStatus === 'loading' ? (
                <Loader2 className="animate-spin text-blue-500" size={60} />
              ) : (
                <Power size={60} className={error ? 'text-red-500' : 'text-blue-500'} />
              )}
            </div>
            
            <div className="space-y-4">
              <h2 className="text-2xl font-black">{error ? "Erro de Ligação" : "Pronto para Iniciar"}</h2>
              <p className="text-slate-400 text-sm max-w-xs mx-auto leading-relaxed">
                {error || "Clique no botão abaixo para ligar os sensores e começar a análise atómica de objetos."}
              </p>
            </div>

            <button 
              onClick={startCamera}
              className="w-full max-w-xs py-5 bg-blue-600 hover:bg-blue-500 text-white font-black text-lg rounded-2xl shadow-2xl shadow-blue-900/40 flex items-center justify-center gap-3 active:scale-95 transition-all"
            >
              <Camera size={24} />
              LIGAR CÂMARA
            </button>
            
            {error && (
              <p className="text-[10px] text-slate-600 uppercase font-bold tracking-tighter">
                Certifique-se que não tem outras apps abertas a usar a câmara
              </p>
            )}
          </div>
        ) : !result ? (
          <div className="relative flex-1">
            <video
              ref={videoRef}
              autoPlay
              playsInline
              muted
              webkit-playsinline="true"
              className="absolute inset-0 w-full h-full object-cover z-10"
              onMouseDown={startScanning}
              onMouseUp={stopScanning}
              onTouchStart={startScanning}
              onTouchEnd={stopScanning}
            />
            
            {/* Interface de Scan */}
            <div className="absolute inset-0 z-20 pointer-events-none flex flex-col items-center justify-center">
              <div className={`w-72 h-72 border-2 rounded-[2.5rem] transition-all duration-300 flex items-center justify-center ${scanning ? 'border-blue-400 scale-105 bg-blue-500/5' : 'border-white/20'}`}>
                <Scan size={40} className={`text-white transition-opacity ${scanning ? 'opacity-100 animate-pulse' : 'opacity-20'}`} />
                
                {/* Cantos Estilizados */}
                {!scanning && (
                  <div className="absolute inset-0 border-4 border-transparent border-t-blue-500/40 border-l-blue-500/40 w-12 h-12 rounded-tl-[2.5rem] top-0 left-0" />
                )}
              </div>
              
              <div className="mt-12 text-center">
                {isLoading ? (
                  <div className="bg-blue-600 px-8 py-3 rounded-full flex items-center gap-3 shadow-2xl animate-bounce">
                    <Loader2 className="animate-spin" size={20} />
                    <span className="font-bold text-sm">A PROCESSAR MATÉRIA...</span>
                  </div>
                ) : (
                  <div className="flex flex-col items-center gap-4">
                    <div className="bg-black/40 backdrop-blur-md px-6 py-2 rounded-full border border-white/10">
                      <p className="text-white font-bold text-xs uppercase tracking-widest">
                        {scanning ? `Progresso: ${progress}%` : "Segure na tela para escanear"}
                      </p>
                    </div>
                  </div>
                )}
              </div>

              {/* Barra de Progresso Circular ou Linear */}
              {scanning && (
                <div className="absolute bottom-20 left-10 right-10 h-1 bg-white/10 rounded-full overflow-hidden">
                  <div 
                    className="h-full bg-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.8)] transition-all duration-100"
                    style={{ width: `${progress}%` }}
                  />
                </div>
              )}
            </div>
          </div>
        ) : (
          /* Ecrã de Resultados */
          <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-950 pb-32">
            <div className="bg-slate-900 rounded-[2rem] p-8 border border-slate-800 relative overflow-hidden">
              <div className="absolute top-0 right-0 p-4 opacity-10">
                <Atom size={80} />
              </div>
              <span className="text-blue-500 text-[10px] font-black uppercase tracking-[0.3em]">Resultado da Análise</span>
              <h2 className="text-4xl font-black mt-2 text-white leading-none">{result.name}</h2>
              <p className="text-slate-400 mt-4 text-sm leading-relaxed font-medium">{result.summary}</p>
            </div>

            <div className="space-y-4">
              <h3 className="text-xs font-black text-slate-500 uppercase tracking-widest ml-2">Espectrometria Estimada</h3>
              
              <div className="grid gap-3">
                {result.elements?.map((el, i) => (
                  <div key={i} className="bg-slate-900/60 backdrop-blur-sm border border-slate-800 p-5 rounded-2xl flex items-center gap-5">
                    <div className="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl flex flex-col items-center justify-center shadow-lg shrink-0">
                      <span className="text-[10px] text-white/60 font-mono mb-1">{i+1}</span>
                      <span className="font-black text-2xl text-white">{el.symbol}</span>
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex justify-between items-center mb-1">
                        <h4 className="font-bold text-slate-100 text-lg truncate">{el.element}</h4>
                        <span className="text-[11px] font-black text-blue-400 bg-blue-400/10 px-2 py-1 rounded-lg">
                          {el.percentage}
                        </span>
                      </div>
                      <p className="text-xs text-slate-500 leading-tight italic line-clamp-2">{el.description}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="fixed bottom-8 left-8 right-8">
              <button 
                onClick={reset}
                className="w-full py-5 bg-white text-black font-black text-lg rounded-2xl shadow-2xl active:scale-95 transition-all"
              >
                NOVA ANÁLISE
              </button>
            </div>
          </div>
        )}

        <canvas ref={canvasRef} className="hidden" />
      </main>
    </div>
  );
};

export default App;

